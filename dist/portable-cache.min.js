/*! PortableCache.js - v0.6.0 - 2014-01-09
* https://github.com/agektmr/PortableCache.js
* Copyright (c) 2014 Eiji Kitamura (agektmr+github@gmail.com); Licensed  */
!function(a,b){var c={version:"","responsive-image":"no","root-path":"","preferred-storage":"auto","debug-mode":"no"},d={width:"device-width",height:"device-height","initial-scale":1,"minimum-scale":1,"maximum-scale":1,"user-scalable":"yes"},e=null,f="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",g="PortableCache",h="NOT_SUPPORTED",i=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,j=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB||void 0,k=a.openDatabase||void 0,l=a.localStorage||void 0,m=a.Blob||a.WebKitBlob||a.MozBlob||a.MsBlob||void 0,n=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MsBlobBuilder||void 0,o=(a.URL||a.webkitURL||a.mozURL||a.msURL||a.oURL||void 0,function(a){for(var b,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",e=-6,f=0,g=0,h=0;g<a.length||e>-6;)0>e&&(g<a.length?(b=a[g++],h+=8):b=0,f=(255&f)<<8|255&b,e+=8),d+=c.charAt(h>0?f>>e&63:64),e-=6,h-=6;return d}),p=function(a){return/^(img|audio|video)/.test(a)},q=function(a,b){var c=null;if(a instanceof m)return a;if(m)try{c=new m([a],{type:b})}catch(d){var e=new n;e.append(a),c=e.getBlob(b)}else if(n){var e=new n;e.append(a),c=e.getBlob(b)}return c},r=function(a,b){b=b||{};for(var c=a.split(/,\s*/g),d=0;d<c.length;d++){var e=c[d].split("=");2===e.length&&(b[e[0]]=e[1])}return b},s=function(a){if(0===a.indexOf("http")||0===a.indexOf("//"))return a;var b=function(a){return""==a?!1:!0},c=location.pathname.split("/").filter(b),d=a.split("/");do switch(d[0]){case"..":c=c.slice(0,-1),d=d.slice(1);break;case".":case"":d=d.slice(1)}while(".."==d[0]);return d=c.concat(d),"/"+d.join("/")},t=a.document.addEventListener?function(a,b,c){a.addEventListener(b,c)}:function(a,b,c){a.attachEvent("on"+b,c)},u=a.document.removeEventListener?function(a,b,c){a.removeEventListener(b,c)}:function(a,b,c){a.detachEvent("on"+b,c)};Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var v={getItem:function(a){return a&&this.hasItem(a)?unescape(b.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},setItem:function(a,c,d,e,f,g){if(a&&!/^(?:expires|max\-age|path|domain|secure)$/i.test(a)){var h="";if(d)switch(d.constructor){case Number:h=1/0===d?"; expires=Tue, 19 Jan 2038 03:14:07 GMT":"; max-age="+d;break;case String:h="; expires="+d;break;case Date:h="; expires="+d.toGMTString()}b.cookie=escape(a)+"="+escape(c)+h+(f?"; domain="+f:"")+(e?"; path="+e:"")+(g?"; secure":"")}},removeItem:function(a,c){a&&this.hasItem(a)&&(b.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; path="+c:""))},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(b.cookie)},keys:function(){for(var a=b.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),c=0;c<a.length;c++)a[c]=unescape(a[c]);return a}},w=function(a){if(this.src="",this.content="",this.mimetype="",this.lazyload=!1,a.nodeName?(this.tag=a.nodeName.toLowerCase(),this.elem=a,this.url=s(a.getAttribute("data-cache-url")),this.version=a.getAttribute("data-cache-version")||c.version,this.type=p(this.tag)?"binary":"text"):(this.tag=a.tag||"",this.elem=null,this.url=s(a.url),this.version=a.version||c.version,this.type=a.type||"text"),""===this.version)throw"Cache version cannot be empty string.";"img"==this.tag&&c.version!=h&&(this.elem.src=f,this.lazyload=null!==a.getAttribute("lazyload")?!0:!1)};w.prototype={load:function(a){var b=function(b){a()};c.version==h||""===this.url?a():null===c["prev-version"]?this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this)):this.readCache(function(c){c?c.version!==this.version?this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!0,a,b.bind(this))}.bind(this),b.bind(this)):(this.src=c.src||"",this.content=c.content||"",this.mimetype=c.mimetype,a()):this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this))}.bind(this),function(b){a()}.bind(this))},readCache:function(a,b){e?e.get(this,a,b):"function"==typeof b&&b("storage not ready")},createCache:function(a,b,c){var d=a&&e instanceof A?"update":"set";return e?(e instanceof y?e.set(this,b,c):this.getContentAs("text",function(a){this.content=a,e[d](this,b,c)}.bind(this)),void 0):("function"==typeof c&&c("storage not ready"),void 0)},removeCache:function(a,b){e?e.remove(this):"function"==typeof b&&b("storage not ready.")},fetch:function(b,c){var d=new XMLHttpRequest,e="string"==typeof d.responseType;d.open("GET",this.url,!0),"binary"==this.type?e?(d.responseType="blob",d.responseType="blob"!==d.responseType?"arraybuffer":"blob"):d.overrideMimeType?d.overrideMimeType("text/plain; charset=x-user-defined"):c("binary not supported on this browser."):"json"==this.type&&(d.responseType="json",d.responseType="json"!=d.responseType?"text":"json"),d.onreadystatechange=function(){if(4===d.readyState){var f={};if(200===d.status||304===d.status){if(f.mimetype=d.getResponseHeader("Content-Type").replace(/^(.*?);.*$/g,"$1"),"binary"==this.type)if(e)"blob"==d.responseType?f.content=d.response:"arraybuffer"==d.responseType&&(f.content=q(d.response,f.mimetype));else if("undefined"!=typeof VBArray)f.content=new VBArray(d.responseBody).toArray();else{for(var g=[],h=d.responseText,i=0;i<h.length;i++){var j=h.charCodeAt(i);g.push(255&j)}f.content="data:"+f.mimetype+";base64,"+o(g)}else if("json"==this.type)if(e)f.content=d.response;else try{f.content=JSON.parse(d.responseText)}catch(k){c("Unparsable JSON response")}else f.content=d.responseText;b(f)}else 0===d.status?-1===this.url.indexOf(a.location.origin)?c("XMLHttpRequest was allowed because of Access-Control-Allow-Origin."):c("XMLHttpRequest unknown error."):c("XMLHttpRequest error: "+d.status)}}.bind(this),d.send()},constructDOM:function(a){switch(a="function"!=typeof a?function(){}:a,this.src||"string"!=typeof this.content||0!==this.content.indexOf("data:")||(this.src=this.content),this.tag){case"audio":case"video":case"img":this.src?(this.elem.setAttribute("src",this.src),a()):(this.elem.setAttribute("src",this.url),t(this.elem,"load",a));break;case"script":if(this.src)this.elem.setAttribute("src",this.src),a();else{if(this.content)return this.elem.textContent=this.content,a(),void 0;this.elem.setAttribute("src",this.url),t(this.elem,"load",a)}break;case"link":this.src?(this.elem.setAttribute("href",this.src),a()):this.content?(this.tag="style",this.elem=b.createElement("style"),this.elem.textContent=this.content,b.head.appendChild(this.elem),a()):(this.elem.setAttribute("href",this.url),t(this.elem,"load",a))}},getContentAs:function(a,b,c){c="function"!=typeof c?function(){}:c;var d=m?new FileReader:null;switch(""==this.content&&c("content not loaded."),a){case"text":d&&this.content instanceof m?(d.onload=function(a){b(a.target.result)}.bind(this),d.readAsDataURL(this.content)):this.content instanceof Array?b("data:"+this.mimetype+";base64,"+o(this.content)):"string"==typeof this.content&&b(this.content);break;case"arraybuffer":if(d&&this.content instanceof m)d.onload=function(a){b(a.target.result)}.bind(this),d.readAsArrayBuffer(this.content);else if(atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(e.buffer)}else c("ArrayBuffer not supported on this browser.");break;case"blob":if(this.content instanceof m)b(this.content);else if(d&&ArrayBuffer&&atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(q(e.buffer,this.mimetype))}else c("Blob not supported on this browser.")}}};var x=function(){this.entries=[],this.lazyload=[];var a=null,f=null;if(b.querySelector)a=b.querySelector('meta[name="portable-cache"]'),f=b.querySelector('meta[name="viewport"]');else for(var g=b.getElementsByTagName("meta"),m=0;m<g.length;m++){var n=g[m].getAttribute("name");"portable-cache"!=n?"viewport"==n&&(f=g[m]):a=g[m]}if(a&&r(a.getAttribute("content"),c),f&&r(f.getAttribute("content"),d),c["prev-version"]=v.getItem("pcache_version"),!1=!1,c["prev-version"]==h||void 0===b.querySelectorAll||void 0===b.textContent||void 0===b.head)c.version=h,t(b,"load",this.bootstrap.bind(this));else{var o=function(a){e=null,"complete"==b.readyState||"interactive"==b.readyState||"loaded"==b.readyState?this.bootstrap():t(b,"load",this.bootstrap.bind(this))},p=c["preferred-storage"];e="filesystem"==p||i&&"auto"==p?new y(this.bootstrap.bind(this),o.bind(this)):"idb"==p||j&&"auto"==p?new z(this.bootstrap.bind(this),o.bind(this)):"sql"==p||k&&"auto"==p?new A(this.bootstrap.bind(this),o.bind(this)):"localstorage"==p||l&&"auto"==p?new B(this.bootstrap.bind(this),o.bind(this)):void 0,e||t(b,"load",this.bootstrap.bind(this))}};x.prototype={bootstrap:function(){var a=function(){this.lazyload.length?this.loadLazyImages():u(b,"scroll",a)}.bind(this);b.body.style.display="none",this.queryElements(["link","script"],function(){b.body.style.display="block";var c;b.createEvent?(c=b.createEvent("HTMLEvents"),c.initEvent("pcache-ready",!0,!1)):c=new Event("pcache-ready",{bubbles:!0,cancelable:!1}),b.dispatchEvent(c),this.queryElements(["img","audio","video"],function(){this.lazyload.length>0&&t(b,"scroll",a)}.bind(this))}.bind(this)),v.setItem("pcache_version",c.version,null,c["root-path"])},queryElements:function(a,c){var d,e=[];for(d=0;d<a.length;d++)for(var f=b.getElementsByTagName(a[d]),g=0;g<f.length;g++)null!==f[g].getAttribute("data-cache-url")&&e.push(f[g]);var h=0,i=e.length;for(d=0;d<e.length;d++){var j=new w(e[d]);this.entries.push(j),j.lazyload?(this.lazyload.push(j),i--):j.load(function(a){a.constructDOM(function(){h++,"function"==typeof c&&h==i&&c()})}.bind(this,j))}"function"==typeof c&&0===i&&c()},loadLazyImages:function(){for(var c=a.pageYOffset||b.documentElement.scrollTop,d=a.innerHeight||b.documentElement.clientHeight,e=c-d/4,f=c+~~(1.25*d),g=0;g<this.lazyload.length;g++){var h=this.lazyload[g],i=h.elem.offsetTop,j=h.elem.offsetHeight;(e>=i+j||f>=i)&&(h.load(function(a){a.constructDOM()}.bind(this,h)),this.lazyload.splice(g--,1))}},getEntryByUrl:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].url===a)return this.entries[b];return void 0},clearAllCache:function(){for(var a=0;a<this.entries.length;a++)this.entries[a].removeCache()},getConfig:function(a){return void 0===a?c:c[a]}};var y=function(a,b){return b="function"!=typeof b?function(){}:b,i?(this.fs=null,i(TEMPORARY,1048576,function(b){this.fs=b,this.ls=new B,"function"==typeof a&&a()}.bind(this),function(){b("failed initializing FileSystem.")}),void 0):(b("FileSystem not supported on this browser."),void 0)};y.prototype={set:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=a.url.replace(/\/|\./g,"_");this.fs.root.getDirectory(g,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.createWriter(function(f){f.onwriteend=function(){a.src=e.toURL();var f={url:a.url,src:a.src,mimetype:a.mimetype,version:a.version};d.set(f,b,c)},f.onerror=function(a){c("error writing FileSystem: "+a)},"string"==typeof a.content?f.write(q(a.content,a.mimetype)):f.write(a.content)})},function(a){c("failed setting content: "+a)})},function(a){c("failed getting directory: "+a)})},get:function(a,b,c){this.ls?this.ls.get(a,b,c):c("storage not ready.")},remove:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=a.url.replace(/\/|\./g,"_");this.fs.root.getDirectory(g,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.remove(function(){d.remove(a,b,c)},function(a){c("failed removing file: "+a)})},function(a){c("failed setting content: "+a)})},function(a){c("failed getting directory: "+a)})}};var z=function(a,b){if(b="function"!=typeof b?function(){}:b,!j)return b("IndexedDB not supported on this browser."),void 0;this.db=null,this.version=1;var c=j.open(g,this.version);c.onsuccess=function(b){this.db=b.target.result,"function"==typeof a&&a()}.bind(this),c.onblocked=function(a){b("opening IndexedDB blocked: "+a.target.error.message)},c.onerror=function(a){b("error on opening IndexedDB: "+a.target.error.message)},c.onupgradeneeded=function(a){this.db=a.target.result,this.db.objectStoreNames.contains("cache")&&this.db.deleteObjectStore("cache");this.db.createObjectStore("cache",{keyPath:"url"})}.bind(this)};z.prototype={set:function(a,b,c){var d={url:a.url,content:a.content,mimetype:a.mimetype,version:a.version},e=this.db.transaction(["cache"],"readwrite").objectStore("cache").put(d);e.onsuccess=function(){"function"==typeof b&&b()},e.onerror=function(){"function"==typeof c&&c("error writing IndexedDB: "+e.error.name)}},get:function(a,b,c){b="function"!=typeof b?function(){}:b;var d=this.db.transaction(["cache"],"readonly").objectStore("cache").get(a.url);d.onsuccess=function(a){if(a.target.result){var c=a.target.result;b(c)}else b(null)},d.onerror=function(){"function"==typeof c&&c("error getting IndexedDB: "+d.error.name)}},remove:function(a,b,c){var d=this.db.transaction(["cache"],"readwrite").objectStore("cache").delete(a.url);d.onsuccess=function(){"function"==typeof b&&b()},d.onerror=function(){"function"==typeof c&&c("error removing IndexedDB: "+d.error.name)}}};var A=function(a,b){return a="function"!=typeof a?function(){}:a,k?(this.version="1.0",this.db=k(g,"","cache",1048576),this.db.version!==this.version?this.db.changeVersion(this.db.version,this.version,function(b){b.executeSql("CREATE TABLE cache (url TEXT PRIMARY KEY, content TEXT, mimetype TEXT, version TEXT)"),a()},function(){"function"==typeof b&&b("Failed changing WebSQL version.")},function(){}):setTimeout(function(){a()},0),void 0):(setTimeout(function(){b("WebSQL not supported on this browser.")},0),void 0)};A.prototype={set:function(a,b,c){this.db.transaction(function(d){d.executeSql("INSERT INTO cache (url, content, mimetype, version) VALUES(?, ?, ?, ?)",[a.url,a.content,a.mimetype,a.version],function(){"function"==typeof b&&b()},function(a,b){"function"==typeof c&&c("error writing WebSQL: "+b.message)})})},update:function(a,b,c){this.db.transaction(function(d){d.executeSql("UPDATE cache SET mimetype=?, content=?, version=? WHERE url=?",[a.mimetype,a.content,a.version,a.url],function(){"function"==typeof b&&b()},function(a,b){"function"==typeof c&&c("error updating WebSQL: "+b.message)})})},get:function(a,b,c){b="function"!=typeof b?function(){}:b,c="function"!=typeof c?function(){}:c,this.db.readTransaction(function(d){d.executeSql("SELECT * FROM cache WHERE url=?",[a.url],function(d,e){if(e.rows.length>0){var f=e.rows.item(0),g={url:a.url,content:f.content,mimetype:f.mimetype,version:f.version};b(g)}else 0===e.rows.length?b(null):c("error getting WebSQL data.")},function(a,b){c("error getting WebSQL data: "+b.message)})})},remove:function(a,b,c){this.db.transaction(function(d){d.executeSql("DELETE FROM cache WHERE url=?",[a.url],function(){"function"==typeof b&&b()},function(a,b){"function"==typeof c&&c("error removing WebSQL cache: "+b.message)})})}};var B=function(a,b){return l?(setTimeout(function(){"function"==typeof a&&a()},0),void 0):("function"==typeof b&&b("LocalStorage not supported on this browser."),void 0)};B.prototype={set:function(a,b,c){var d={src:a.src||"",content:a.content||"",mimetype:a.mimetype,version:a.version};setTimeout(function(){try{l.setItem(a.url,JSON.stringify(d)),"function"==typeof b&&b()}catch(e){"function"==typeof c&&c(e.message)}},0)},get:function(a,b,c){setTimeout(function(){try{var d=l.getItem(a.url)||null;d&&(d=JSON.parse(d)),"function"==typeof b&&b(d)}catch(e){"function"==typeof c&&c(e.message)}},0)},remove:function(a,b,c){setTimeout(function(){try{l.removeItem(a.url),"function"==typeof b&&b()}catch(d){"function"==typeof c&&c(d.message)}},0)}},a.CacheEntry=w,a.CacheManager=new x}(window,document);