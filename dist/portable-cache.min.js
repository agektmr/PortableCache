/*! portable-cache.js - v0.6.0 - 2014-01-12
* https://github.com/agektmr/PortableCache.js
* Copyright (c) 2014 Eiji Kitamura (agektmr+github@gmail.com); Licensed  */
!function(a,b){var c={version:"","auto-init":"yes","root-path":"/","preferred-storage":"auto","debug-mode":"no"},d=null,e="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f="PortableCache",g="NOT_SUPPORTED",h=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,i=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB||void 0,j=a.openDatabase||void 0,k=a.localStorage||void 0,l=a.Blob||a.WebKitBlob||a.MozBlob||a.MsBlob||void 0,m=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MsBlobBuilder||void 0,n=(a.URL||a.webkitURL||a.mozURL||a.msURL||a.oURL||void 0,a.document.addEventListener?function(a,b,c){a.addEventListener(b,c)}:function(a,b,c){a.attachEvent("on"+b,c)}),o=a.document.removeEventListener?function(a,b,c){a.removeEventListener(b,c)}:function(a,b,c){a.detachEvent("on"+b,c)};Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var p=function(a){for(var b,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",e=-6,f=0,g=0,h=0;g<a.length||e>-6;)0>e&&(g<a.length?(b=a[g++],h+=8):b=0,f=(255&f)<<8|255&b,e+=8),d+=c.charAt(h>0?f>>e&63:64),e-=6,h-=6;return d},q=function(a,b){var c=null;if(a instanceof l)return a;if(l)try{c=new l([a],{type:b})}catch(d){var e=new m;e.append(a),c=e.getBlob(b)}else if(m){var e=new m;e.append(a),c=e.getBlob(b)}return c},r=function(a){if(0===a.indexOf("http")||0===a.indexOf("//"))return a;var b=function(a){return""===a?!1:!0},c=location.pathname.split("/").filter(b),d=a.split("/");do switch(d[0]){case"..":c=c.slice(0,-1),d=d.slice(1);break;case".":case"":d=d.slice(1)}while(".."==d[0]);return d=c.concat(d),"/"+d.join("/")},s=function(b,c,d,e){if(null===c)return b;d=d||a.devicePixelRatio,e=e||a.innerWidth;var f,g=c.split(/\s*,\s*/g),h=[],i=0;for(h.push({url:b,w:1/0,x:1}),i=0;i<g.length;i++){var j=g[i].split(/\s+/g);if(!(j.length<2)){for(var k,l=j.shift(),m={url:l,x:1,w:1/0};k=j.shift(),void 0!==k;){var n=k.match(/^([0-9\.]+)(w|x)$/);n&&3===n.length&&(m[n[2]]=1*n[1])}h.push(m)}}var o=1/0,p=0;for(i=0;i<h.length;i++)f=h[i],e<=f.w&&f.w<=o&&(o=f.w);for(i=0;i<h.length;i++)f=h[i],f.w===o&&(0===p?p=f.x:d<=f.x&&(d>p||f.x<p)&&(p=f.x));for(i=0;i<h.length;i++)if(f=h[i],f.x==p&&f.w==o)return f.url;return b},t=function(c){for(var d=a.pageYOffset||b.documentElement.scrollTop,e=a.innerHeight||b.documentElement.clientHeight,f=d-e/4,g=d+~~(1.25*e),h=0;h<c.length;h++){var i=c[h],j=i.elem.offsetTop,k=i.elem.offsetHeight;(f>=j+k||g>=j)&&(i.load(function(a){a.constructDOM()}),c.splice(h--,1))}},u={getItem:function(a){return a&&this.hasItem(a)?unescape(b.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},setItem:function(a,c,d,e,f,g){if(a&&!/^(?:expires|max\-age|path|domain|secure)$/i.test(a)){var h="";if(d)switch(d.constructor){case Number:h=1/0===d?"; expires=Tue, 19 Jan 2038 03:14:07 GMT":"; max-age="+d;break;case String:h="; expires="+d;break;case Date:h="; expires="+d.toGMTString()}b.cookie=escape(a)+"="+escape(c)+h+(f?"; domain="+f:"")+(e?"; path="+e:"")+(g?"; secure":"")}},removeItem:function(a,c){a&&this.hasItem(a)&&(b.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; path="+c:""))},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(b.cookie)},keys:function(){for(var a=b.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),c=0;c<a.length;c++)a[c]=unescape(a[c]);return a}},v=function(a){if(this.src="",this.content="",this.mimetype="",this.lazyload=!1,a.nodeName){this.tag=a.nodeName.toLowerCase(),this.elem=a;var b=a.getAttribute("data-cache-url"),d=a.getAttribute("data-cache-srcset");this.url=c.version!=g?r(s(b,d)):s(b,d);var f=a.getAttribute("data-cache-version");this.version=null!==f?f:c.version,this.async=null===a.getAttribute("async")?!1:!0,this.type=/^(img|audio|video)/.test(this.tag)?"binary":"text"}else this.tag=a.tag||"",this.elem=null,this.url=r(a.url),this.version="string"==typeof a.version?a.version:c.version,this.type=a.type||"text";"img"==this.tag&&c.version!=g&&(this.elem.src=e,this.lazyload=null!==a.getAttribute("lazyload")?!0:!1)};v.prototype={load:function(a){a="function"!=typeof a?function(){}:a;var b=function(b){a(this)};""===this.version||c.version==g?a(this):null===c["prev-version"]?this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this)):this.readCache(function(c){c?c.version!==this.version?this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!0,a,b.bind(this))}.bind(this),b.bind(this)):(this.src=c.src||"",this.content=c.content||"",this.mimetype=c.mimetype,a(this)):this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this))}.bind(this),function(b){a(this)}.bind(this))},readCache:function(a,b){d?d.get(this,a,b):"function"==typeof b&&b("storage not ready")},createCache:function(a,b,c){var e=a&&d instanceof z?"update":"set";return d?(d instanceof x?d.set(this,b,c):this.getContentAs("text",function(a){this.content=a,d[e](this,b,c)}.bind(this)),void 0):("function"==typeof c&&c("storage not ready"),void 0)},removeCache:function(a,b){d?d.remove(this):"function"==typeof b&&b("storage not ready.")},fetch:function(b,c){var d=new XMLHttpRequest,e="string"==typeof d.responseType;d.open("GET",this.url,!0),"binary"==this.type?e?(d.responseType="blob",d.responseType="blob"!==d.responseType?"arraybuffer":"blob"):d.overrideMimeType?d.overrideMimeType("text/plain; charset=x-user-defined"):c("binary not supported on this browser."):"json"==this.type&&(d.responseType="json",d.responseType="json"!=d.responseType?"text":"json"),d.onreadystatechange=function(){if(4===d.readyState){var f={};if(200===d.status||304===d.status){if(f.mimetype=d.getResponseHeader("Content-Type").replace(/^(.*?);.*$/g,"$1"),"binary"==this.type)if(e)"blob"==d.responseType?f.content=d.response:"arraybuffer"==d.responseType&&(f.content=q(d.response,f.mimetype));else if("undefined"!=typeof VBArray)f.content=new VBArray(d.responseBody).toArray();else{for(var g=[],h=d.responseText,i=0;i<h.length;i++){var j=h.charCodeAt(i);g.push(255&j)}f.content="data:"+f.mimetype+";base64,"+p(g)}else if("json"==this.type)if(e)f.content=d.response;else try{f.content=JSON.parse(d.responseText)}catch(k){c("Unparsable JSON response")}else f.content=d.responseText;b(f)}else 0===d.status?-1===this.url.indexOf(a.location.origin)?c("XMLHttpRequest was not allowed because of Access-Control-Allow-Origin."):c("XMLHttpRequest unknown error."):c("XMLHttpRequest error: "+d.status)}}.bind(this),d.send()},constructDOM:function(a){switch(a="function"!=typeof a?function(){}:a,this.src||"string"!=typeof this.content||0!==this.content.indexOf("data:")||(this.src=this.content),this.tag){case"audio":case"video":case"img":this.src?(this.elem.setAttribute("src",this.src),a()):(this.elem.setAttribute("src",this.url),n(this.elem,"load",a));break;case"script":if(this.src)this.elem.async=this.async,this.elem.setAttribute("src",this.src),n(this.elem,"load",a);else{if(this.content)return this.tag="script",this.elem=b.createElement("script"),this.elem.async=this.async,this.elem.textContent=this.content,b.head.appendChild(this.elem),a(),void 0;this.elem.async=this.async,this.elem.setAttribute("src",this.url),n(this.elem,"load",a)}break;case"link":this.src?(this.elem.setAttribute("href",this.src),a()):this.content&&"stylesheet"==this.elem.rel?(this.tag="style",this.elem=b.createElement("style"),this.elem.textContent=this.content,b.head.appendChild(this.elem),a()):(this.elem.setAttribute("href",this.url),n(this.elem,"load",a))}},getContentAs:function(a,b,c){c="function"!=typeof c?function(){}:c;var d=l?new FileReader:null;switch(""==this.content&&c("content not loaded."),a){case"text":d&&this.content instanceof l?(d.onload=function(a){b(a.target.result)}.bind(this),d.readAsDataURL(this.content)):this.content instanceof Array?b("data:"+this.mimetype+";base64,"+p(this.content)):"string"==typeof this.content&&b(this.content);break;case"arraybuffer":if(d&&this.content instanceof l)d.onload=function(a){b(a.target.result)}.bind(this),d.readAsArrayBuffer(this.content);else if(atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(e.buffer)}else c("ArrayBuffer not supported on this browser.");break;case"blob":if(this.content instanceof l)b(this.content);else if(d&&ArrayBuffer&&atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(q(e.buffer,this.mimetype))}else c("Blob not supported on this browser.")}}};var w=function(){this.entries=[],this.lazyload=[],c=this.parseConfig(),c["prev-version"]=u.getItem("pcache_version"),!1=!1;var e="no"!=c["auto-init"]?this.bootstrap.bind(this):function(){};if(c["prev-version"]==g||void 0===b.querySelectorAll||void 0===b.textContent||void 0===b.head)c.version=g,n(a,"load",e);else{var f=function(f){d=null,"no"!=c["auto-init"]&&("complete"==b.readyState||"interactive"==b.readyState||"loaded"==b.readyState?this.bootstrap():n(a,"load",e))},l=c["preferred-storage"];d="filesystem"==l||h&&"auto"==l?new x(e,f.bind(this)):"idb"==l||i&&"auto"==l?new y(e,f.bind(this)):"sql"==l||j&&"auto"==l?new z(e,f.bind(this)):"localstorage"==l||k&&"auto"==l?new A(e,f.bind(this)):void 0,d||n(a,"load",e)}};w.prototype={bootstrap:function(){var a=function(){this.lazyload.length?t(this.lazyload):o(b,"scroll",a)}.bind(this);b.body.style.display="none",this.queryTags(["link","script"],function(){if(b.body.style.display="block",c.version!=g){var d;b.createEvent?(d=b.createEvent("HTMLEvents"),d.initEvent("pcache-ready",!0,!1)):d=new Event("pcache-ready",{bubbles:!0,cancelable:!1}),b.dispatchEvent(d)}this.queryTags(["img","audio","video"],function(){this.lazyload.length>0&&n(b,"scroll",a)}.bind(this))}.bind(this)),u.setItem("pcache_version",c.version,null,c["root-path"])},resolveTag:function(a,c){for(var d=b.getElementsByTagName(a),e=d.length,f=0,g=0,h=0,i=[],j=[],k=function(){g++,f===g&&"function"==typeof c&&c()},l=0;e>l;l++)if(null!==d[l].getAttribute("data-cache-url")){f++;var m=new v(d[l]);this.entries.push(m),m.lazyload?(f--,this.lazyload.push(m)):("script"!=m.tag||m.async||i.push(m),m.load(function(a){if("script"!=a.tag||a.async)a.constructDOM(k);else{var b=i.indexOf(a);if(j[b]=a,b===h)for(;j[h];)i[h++].constructDOM(k)}}))}0===f&&"function"==typeof c&&c()},queryTags:function(a,b){for(var c=0,d=a.length;a.length;)this.resolveTag(a.shift(),function(){++c==d&&"function"==typeof b&&b()})},parseConfig:function(){var a=null;if(b.querySelector)a=b.querySelector('meta[name="portable-cache"]');else for(var d=b.getElementsByTagName("meta"),e=0;e<d.length;e++){var f=d[e].getAttribute("name");if("portable-cache"==f){a=d[e];break}}if(a)for(var g=a.getAttribute("content"),h=g.split(/\s*,\s*/g),i=0;i<h.length;i++){var j=h[i].split("=");2===j.length&&(c[j[0]]=j[1])}return c},getEntryByUrl:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].url===a)return this.entries[b];return void 0},clearAllCache:function(){for(var a=0;a<this.entries.length;a++)this.entries[a].removeCache()},getConfig:function(a){return void 0===a?c:c[a]}};var x=function(a,b){return b="function"!=typeof b?function(){}:b,h?(this.fs=null,h(TEMPORARY,1048576,function(b){this.fs=b,this.ls=new A,"function"==typeof a&&a()}.bind(this),function(){b("failed initializing FileSystem.")}),void 0):(b("FileSystem not supported on this browser."),void 0)};x.prototype={set:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.createWriter(function(f){f.onwriteend=function(){a.src=e.toURL();var f={url:a.url,src:a.src,mimetype:a.mimetype,version:a.version};d.set(f,function(){b(a)},c)},f.onerror=function(a){c("error writing FileSystem: "+a)},"string"==typeof a.content?f.write(q(a.content,a.mimetype)):f.write(a.content)})},function(a){c("failed setting content: "+a)})},function(a){c("failed getting directory: "+a)})},get:function(a,b,c){this.ls?this.ls.get(a,function(d){if(null===d)b(d);else if(null===a.elem){var e=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(a){a.getFile(e,{create:!1,exclusive:!1},function(a){a.file(function(a){d.content=a,b(d)},function(a){c("failed getting content: "+a.message)})},function(a){b(null)})},function(a){c("failed getting directory: "+a.message)})}else b(d)}.bind(this),c):c("storage not ready.")},remove:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=a.url.replace(/\/|\./g,"_");this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.remove(function(){d.remove(a,b,c)},function(a){c("failed removing file: "+a)})},function(a){c("failed setting content: "+a)})},function(a){c("failed getting directory: "+a)})},convertURL:function(a){return a.replace(/\/|\\/g,"_")}};var y=function(a,b){if(b="function"!=typeof b?function(){}:b,!i)return b("IndexedDB not supported on this browser."),void 0;this.db=null,this.version=1;var c=i.open(f,this.version);c.onsuccess=function(b){this.db=b.target.result,"function"==typeof a&&a()}.bind(this),c.onblocked=function(a){b("opening IndexedDB blocked: "+a.target.error.message)},c.onerror=function(a){b("error on opening IndexedDB: "+a.target.error.message)},c.onupgradeneeded=function(a){this.db=a.target.result,this.db.objectStoreNames.contains("cache")&&this.db.deleteObjectStore("cache");this.db.createObjectStore("cache",{keyPath:"url"})}.bind(this)};y.prototype={set:function(a,b,c){var d={url:a.url,content:a.content,mimetype:a.mimetype,version:a.version},e=this.db.transaction(["cache"],"readwrite").objectStore("cache").put(d);e.onsuccess=function(){"function"==typeof b&&b(a)},e.onerror=function(){"function"==typeof c&&c("error writing IndexedDB: "+e.error.name)}},get:function(a,b,c){b="function"!=typeof b?function(){}:b;var d=this.db.transaction(["cache"],"readonly").objectStore("cache").get(a.url);d.onsuccess=function(a){if(a.target.result){var c=a.target.result;b(c)}else b(null)},d.onerror=function(){"function"==typeof c&&c("error getting IndexedDB: "+d.error.name)}},remove:function(a,b,c){var d=this.db.transaction(["cache"],"readwrite").objectStore("cache"),e=d["delete"](a.url);e.onsuccess=function(){"function"==typeof b&&b()},e.onerror=function(){"function"==typeof c&&c("error removing IndexedDB: "+e.error.name)}}};var z=function(a,b){return a="function"!=typeof a?function(){}:a,j?(this.version="1.0",this.db=j(f,"","cache",1048576),this.db.version!==this.version?this.db.changeVersion(this.db.version,this.version,function(b){b.executeSql("CREATE TABLE cache (url TEXT PRIMARY KEY, content TEXT, mimetype TEXT, version TEXT)"),a()},function(){"function"==typeof b&&b("Failed changing WebSQL version.")},function(){}):setTimeout(function(){a()},0),void 0):(setTimeout(function(){b("WebSQL not supported on this browser.")},0),void 0)};z.prototype={set:function(a,b,c){this.db.transaction(function(d){d.executeSql("INSERT INTO cache (url, content, mimetype, version) VALUES(?, ?, ?, ?)",[a.url,a.content,a.mimetype,a.version],function(){"function"==typeof b&&b(a)},function(a,b){"function"==typeof c&&c("error writing WebSQL: "+b.message)})})},update:function(a,b,c){this.db.transaction(function(d){d.executeSql("UPDATE cache SET mimetype=?, content=?, version=? WHERE url=?",[a.mimetype,a.content,a.version,a.url],function(){"function"==typeof b&&b(a)},function(a,b){"function"==typeof c&&c("error updating WebSQL: "+b.message)})})},get:function(a,b,c){b="function"!=typeof b?function(){}:b,c="function"!=typeof c?function(){}:c,this.db.readTransaction(function(d){d.executeSql("SELECT * FROM cache WHERE url=?",[a.url],function(d,e){if(e.rows.length>0){var f=e.rows.item(0),g={url:a.url,content:f.content,mimetype:f.mimetype,version:f.version};b(g)}else 0===e.rows.length?b(null):c("error getting WebSQL data.")},function(a,b){c("error getting WebSQL data: "+b.message)})})},remove:function(a,b,c){this.db.transaction(function(d){d.executeSql("DELETE FROM cache WHERE url=?",[a.url],function(){"function"==typeof b&&b()},function(a,b){"function"==typeof c&&c("error removing WebSQL cache: "+b.message)})})}};var A=function(a,b){return k?(setTimeout(function(){"function"==typeof a&&a()},0),void 0):("function"==typeof b&&b("LocalStorage not supported on this browser."),void 0)};A.prototype={set:function(a,b,c){var d={src:a.src||"",content:a.content||"",mimetype:a.mimetype,version:a.version};setTimeout(function(){try{k.setItem(a.url,JSON.stringify(d)),"function"==typeof b&&b(a)}catch(e){"function"==typeof c&&c(e.message)}},0)},get:function(a,b,c){setTimeout(function(){try{var d=k.getItem(a.url)||null;d&&(d=JSON.parse(d)),"function"==typeof b&&b(d)}catch(e){"function"==typeof c&&c(e.message)}},0)},remove:function(a,b,c){setTimeout(function(){try{k.removeItem(a.url),"function"==typeof b&&b()}catch(d){"function"==typeof c&&c(d.message)}},0)}},a.CacheEntry=v,a.CacheManager=new w}(window,document);